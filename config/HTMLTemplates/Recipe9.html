<center><h2>[[#wd Lookup TitleRecipe9 ]]</h2></center>

<h3>Overview</h3>
<p>Coast uses a role concept to control access to different Web pages.<br>
This recipe describes how a special login page is created and how Coast 
needs to be setup for the enforcement of the necessary role exchanges. 
<h3>Preconditions</h3>
<ul>
	<li>The basic setup for the roles and pages used by the application already exists (see [[#wd Lookup Recipe8 ]]).</li>
	<li>Setup of the basic page transition map (action map) for each Role is known.
		<p><font size=-1>(<b>CAUTION</b>: Conceptually Roles are linearly ordered. This implies that the
		action map of a higher level Role must be a superset of the maps of all 
		lower level Roles, i.e. all actions that are handled by a lower level Role
		need to be handled by a higher level Role.)</font></i>
	</li>
</ol>
<h3>Steps to do:</h3>
<ol>
	<li>Configuration of the Role that is used initially.<br>
		This is done in the /Roles section of Config.any.<br>
		Example: The role Guest should be used for any new user entering the system.
		The following entry is added to Config.any:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {			
		"/Roles {"
		"	/Guest {"
		"		&#34;Default&#34;"
		"	}"
		"}"
	}
}]]
</pre>
		<i>(Because of our examples 1 and 2 it's in our application /Role instead of /Guest.)</i><br><br>
	</li>					
	<li>Setup of the user levels for the different Roles.<br>
		Each Role is assigned a user level: 
		<ul>
			<li>Create a configuration file for role
				Role (Role.any) and add a slot for each role used by the application.</li>
			<li>Assign a level to each entry. (The higher the level, the more trusted the 
				role. Since Role is the ancestor of all roles in the system, all settings in 
				Role.any are shared by all roles.)</li>
		</ul>		
		Example: There are the two roles GuestRole and CustomerRole. Guest has no special 
		privileges whereas Customer is a user with special rights. The 
		following entries are added in Role.any:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"/GuestRole     0"
		"/CustomerRole  1"
	}
}]]
</pre>
	</li>
	<li>Definition of special actions that serve to trigger a role exchange.<br>
		Special actions are used to trigger role exchanges. These actions - along with 
		the name of the new role - form a map in the /RoleChanges section of Config.any.<br>
		Example:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"/RoleChanges {"
		"	/LoginOk  &#34;CustomerRole&#34;"
		"	/Logout   &#34;GuestRole&#34;"
		"}"
	}
}]]
</pre>
		The special action LoginOk is used to enter role CustomerRole. (This 
		action is typically generated by some program code (see later).
		Reversely a Logout action is used to leave the privileged CustomerRole role.

		<p>Notice: A Logout action may be generated by the Coast framework. Logout
		therefore usually belongs into every action/page map!

		<p>A Logout action may also be used directly for a 'Sign off' link/button 
		embedded into any page. The renderer specification for a Logout link 
		might look like this:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"/LogoutLink {"
		"	/Link {"
		"		/Action &#34;Logout&#34;"
		"		/Label {"
		"			/String {"
		"				/Default &#34;Logout&#34;"
		"			}"
		"		}"
		"	}"
		"}"
	}
}]]
</pre>
	</li>
	<li>Setup of a login page (This page invokes an initial login 
		action - which is later used to perform the necessary checks).<br>
		The configuration of a login page is not much different from that of any 
		other page (see general Page configuration). An HTML FORM is used to collect 
		the necessary input from the user. A specified action is automatically 
		generated upon submission of the FORM. To check the settings, some code
		for that action may be written (see later). 

		<p>Example: In our application the page Ex3Page is used to sign on. The page 
		is designed to contain two input fields: one for the user name and another 
		one for the password. Upon submission of the input a MyDoCheckPassword is 
		triggered (Some code for MyDoCheckPassword Action is used to check the 
		password... see later).

		<p>Ex3Page uses the file Ex3Page.html for the general layout of
		the page. This is a section of this template file:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"..."
		"User:       &#91;&#91;&#35;wd Lookup NameField &#93;&#93;"
		"Password:   &#91;&#91;&#35;wd Lookup PasswordField &#93;&#93;"
		"&lt;center>&#91;&#91;&#35;wd Lookup SubmitButton &#93;&#93;&lt;/center>"
		"..."
	}
}]]
</pre>
		The referenced building blocks have to be defined in Ex3Page.any:
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"/Body {"
		"	/Form {"
		"		/Method       &#34;POST&#34;"
		"		/Action       &#34;MyDoCheckPassword&#34;"
		"		/TemplateName &#34;Ex3Page&#34;"
		"	}"
		"}"
		" "
		"/NameField {"
		"	/Text {"
		"		/Name 	&#34;resultLoginName&#34;"
		"		/Value	&#34;lookupLoginDefault&#34;"
		"		/Size	 16"
		"	}"
		"}"
		" "
		"/PasswordField {"
		"	/Text {"
		"		/Name 		&#34;resultPassword&#34;"
		"		/Value		&#34;lookupPasswdDefault&#34;"
		"		/Unreadable 1"
		"		/Size		16"
		"	}"
		"}"
		" "
		"/SubmitButton {"
		"	/Button {"
		"		/Name  &#34;submit&#34;"
		"		/Label {"
		"			/String {"
		"				/Default &#34;   Login   &#34;"
		"			}"
		"		}"
		"	}"
		"}"
	}
}]]
</pre>
		Reminder: Upon clicking on the 'Login' button, the FORM sends all the
		contents of the input fields including a MyDoCheckPassword action.<br><br>
	</li>		
	<li>Include the login page into the different Role action maps.<br>
		To be accessible, the new login page (Ex3Page) needs to be registered in the 
		action/page maps of the different Roles. 

		<p>Important: Coast automatically generates a 'Login' action whenever a 
		user needs to authenticate - because the level of his role is too low. All 
		action/page maps therefore should always contain a /Login entry that points 
		to a login page.

		<p>Example: The /Login entry has to be added to the maps of GuestRole and CustomerRole.
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"/Map {"
		"	/Default {"
		"		..."
		"		/Login &#34;Ex3Page&#34;"
		"		..."
		"	}"
		"}"
	}
}]]
</pre>
	</li>
	<li>Creation of some code for the initial login action.<br>
		The code checks if a role change is acceptable and eventually generates a
		special trigger-action. The final step is to write some code for the action
		that is generated by the login page (Ex3Page). That code is used to check
		the password and eventually trigger a role change.

		<p>Example: Some code for MyDoCheckPassword needs to be written - so as to 
		decide if a role change is allowed. 
<pre>[[#wd DisplayAnythingRenderer {
	/AnythingInfo {
		"bool MyDoCheckPassword::DoAction(String &action, Context& c)"
		"{"
		"	Anything fields = c.GetQuery()[&#34;fields&#34;];"
		"		"
		"	// make the needed checks"
		"	String name = fields[&#34;resultLoginName&#34;].AsString(&#34;&#34;);"
		"	String password = fields[&#34;resultPassword&#34;].AsString(&#34;&#34;);"
		"	"
		"	if ( password == &#34;xy&#34; ) {"
		"		   action = &#34;LoginOk&#34;;"
		"	}"
		"	else {"
		"		action = &#34;LoginFailed&#34;;"
		"	}"
		"	return true;"
		"}"
	}
}]]
</pre>
		Notice: Of course the action "LoginFailed" also needs to be added to the
		action/page maps (Unless an action that already existed was chosen.)
	</li>
</ol>

<h3>Remarks</h3>
<p>There are advanced issues with regard to access control that were not covered in this example.
<h3>Glossary</h3>
<h3>Related Topics</h3>
<p>setup of Roles, setup of Pages, Actions in Links/Forms, 
using Forms&Fields, writing actions, advanced access control (different Customers), 
action/page map (what are the minimal actions to support... framework generated actions...)
<ul>
	<li>[[#wd Lookup Recipe8 ]]: [[#wd Lookup TitleRecipe8 ]]</li>
	<li>[[#wd Lookup Recipe11 ]]: [[#wd Lookup TitleRecipe11 ]]</li>
</ul>
